# 🤖 学霸外Game系统 Agent 指南

## 🎯 概述

大模型已成功改造为"学霸外Game系统"的智能Agent，能够：
- 理解游戏系统上下文（用户属性、任务状态）
- 主动识别学习目标和任务需求
- 结构化输出任务信息
- 自动创建任务并与任务系统联动

## ✨ 核心功能

### 1. Agent系统提示词

Agent拥有完整的系统提示词，包括：
- **系统背景**：了解八项核心能力系统
- **用户状态**：实时了解用户属性和任务进度
- **核心职责**：任务识别、结构化输出、进度跟踪、游戏化激励
- **任务识别场景**：明确何时需要创建任务
- **输出格式**：标准化的任务信息格式

### 2. 结构化任务输出

当用户表达学习目标时，Agent会在回复中包含结构化任务信息：

**示例对话：**
```
用户："我想提高计算机水平"

AI回复：
"太好了！我来为你制定一个提升计算机能力的计划。我建议从基础编程开始，每天完成一些编程练习。

我已经为你创建了任务，可以在任务页面查看！

<task>
{
  "hasTask": true,
  "tasks": [
    {
      "title": "完成每日编程练习",
      "description": "每天完成至少1道编程题目或学习1个编程概念",
      "rewardAttr": "计算机能力",
      "rewardExp": 15
    }
  ]
}
</task>"
```

### 3. 自动任务导入

系统会自动：
1. 解析AI回复中的`<task>`标签
2. 提取任务信息
3. 自动导入到任务系统
4. 提示用户查看新创建的任务

### 4. 上下文感知

Agent能够访问：
- **用户属性**：所有能力的等级和经验值
- **进行中任务**：当前任务列表和进度
- **已完成任务**：最近完成的任务和评级

这使得Agent能够：
- 根据用户当前能力水平推荐合适的任务
- 避免创建重复任务
- 提供个性化的学习建议

## 🔄 系统联动流程

### 完整流程

```
用户输入
  ↓
前端收集用户属性和任务信息
  ↓
调用AI接口（传递上下文）
  ↓
Agent分析并生成回复 + 任务信息
  ↓
后端解析任务信息
  ↓
前端接收回复和任务数据
  ↓
自动导入任务到任务系统
  ↓
提示用户查看新任务
```

### 技术实现

#### 1. 后端API (`server/index.js`)

**系统提示词生成：**
```javascript
function getSystemPrompt(userAttributes, userTasks) {
  // 生成包含用户状态的系统提示词
  // 包含任务识别规则和输出格式要求
}
```

**任务解析：**
```javascript
function parseTaskFromReply(replyContent) {
  // 从AI回复中提取<task>标签
  // 解析JSON格式的任务信息
  // 返回清理后的回复和任务数据
}
```

**API响应：**
```json
{
  "code": 0,
  "data": {
    "choices": [{
      "message": {
        "content": "清理后的AI回复（不含任务标签）"
      }
    }]
  },
  "taskData": {
    "hasTask": true,
    "tasks": [...]
  }
}
```

#### 2. 前端调用 (`utils/ai.js`)

```javascript
function callAI(messages, provider, userAttributes, userTasks) {
  // 传递用户属性和任务信息
  // 返回回复和任务数据
  return {
    reply: "AI回复内容",
    taskData: { hasTask: true, tasks: [...] }
  };
}
```

#### 3. 自动导入 (`pages/chat/chat.js`)

```javascript
// 在AI回复后自动检查任务
if (taskData && taskData.hasTask) {
  handleAutoImportTasks(taskData.tasks);
  // 显示提示，询问是否前往任务页面
}
```

## 📋 任务识别场景

Agent会在以下情况自动创建任务：

1. **能力提升需求**
   - "我想提高计算机水平"
   - "想提升自律能力"
   - "如何提高科研能力？"

2. **具体学习目标**
   - "我要学习Python"
   - "今天要刷3道LeetCode"
   - "准备写一篇论文"

3. **学习计划**
   - "制定一个学习计划"
   - "我想每天练习编程"
   - "准备参加比赛"

4. **任务相关对话**
   - "帮我创建一个任务"
   - "我想完成XX目标"

## 🎮 游戏化特性

### Agent的语言风格

- **激励性**：用游戏化的语言鼓励用户
- **个性化**：根据用户当前状态提供建议
- **目标导向**：主动识别并创建任务

### 示例对话

**场景1：能力提升**
```
用户："我想提高计算机水平"

AI："太好了！我看到你的计算机能力目前是Lv.2，我来为你制定一个提升计划。建议从基础编程练习开始，每天完成一些编程题目。

我已经为你创建了任务，可以在任务页面查看！"
```

**场景2：具体目标**
```
用户："今天要刷3道LeetCode"

AI："很棒的目标！LeetCode练习是提升算法能力的好方法。我来为你创建一个任务，完成后可以获得计算机能力经验。

任务已创建，加油完成吧！"
```

## 🔧 配置说明

### 系统提示词位置

`server/index.js` 中的 `getSystemPrompt()` 函数

### 任务输出格式

Agent必须按照以下格式输出任务信息：

```json
<task>
{
  "hasTask": true,
  "tasks": [
    {
      "title": "任务标题",
      "description": "任务描述",
      "rewardAttr": "奖励属性",
      "rewardExp": 经验值
    }
  ]
}
</task>
```

### 任务属性要求

- **title**：简洁明确，可执行
- **description**：详细描述（可选）
- **rewardAttr**：必须是八项能力之一
- **rewardExp**：建议10-50，根据难度调整

## 🐛 故障排除

### Q1: AI没有创建任务

**可能原因：**
- 用户输入不够明确
- AI没有识别到任务需求

**解决方案：**
- 明确表达学习目标
- 使用"我想提高XX"、"我要学习XX"等句式

### Q2: 任务信息解析失败

**可能原因：**
- AI输出格式不正确
- JSON解析错误

**解决方案：**
- 检查后端日志
- 确认AI模型支持结构化输出

### Q3: 任务没有自动导入

**可能原因：**
- 前端解析失败
- 任务数据格式错误

**解决方案：**
- 检查控制台日志
- 确认`taskData`格式正确

## 📊 数据流

### 请求流程

```
前端 → 收集用户属性/任务 → 调用AI接口
  ↓
后端 → 生成系统提示词 → 调用AI API
  ↓
AI → 生成回复+任务信息 → 返回给后端
  ↓
后端 → 解析任务信息 → 返回给前端
  ↓
前端 → 显示回复 → 自动导入任务
```

### 上下文信息

每次AI调用都会传递：
- **userAttributes**：用户所有能力属性
- **userTasks**：所有任务（进行中+已完成）

## 🚀 使用示例

### 示例1：提升能力

```
用户："我想提高计算机水平"

系统流程：
1. Agent识别到能力提升需求
2. 查看用户当前计算机能力等级
3. 生成个性化建议
4. 创建合适的任务
5. 自动导入到任务系统
6. 提示用户查看
```

### 示例2：具体目标

```
用户："今天要刷3道LeetCode"

系统流程：
1. Agent识别到具体任务目标
2. 创建对应任务
3. 设置合理的奖励（计算机能力+经验）
4. 自动导入
5. 鼓励用户完成
```

## 📝 更新日志

- v1.0.0 - Agent系统初始版本
  - ✅ 系统提示词设计
  - ✅ 结构化任务输出
  - ✅ 自动任务导入
  - ✅ 上下文感知
  - ✅ 系统联动

---

**🎉 Agent系统已完全集成，AI现在真正成为了"学霸外Game系统"的智能助手！**

用户只需在对话中表达学习目标，AI就会自动创建任务，实现无缝联动！

