# 🔧 故障排除指南

## 常见问题

### 1. 请求超时错误

**错误信息：**
```
AI请求失败: Error: 请求超时，请重试
```

**可能原因：**
1. 后端服务未启动
2. 网络连接问题
3. AI API响应时间过长
4. 防火墙阻止连接

**解决方案：**

#### 步骤1：检查后端服务
```bash
# 在浏览器访问
http://localhost:3000/health

# 应该看到：
{"status":"ok","message":"AI服务运行正常",...}
```

如果无法访问，说明后端服务未启动：
```bash
cd server
npm start
```

#### 步骤2：检查微信开发者工具配置
1. 点击右上角 **"详情"**
2. 勾选 **"不校验合法域名、web-view（业务域名）、TLS版本以及HTTPS证书"**

#### 步骤3：检查网络连接
- 确保电脑和手机在同一网络（真机调试时）
- 检查防火墙是否阻止了3000端口
- 尝试重启后端服务

#### 步骤4：检查AI API配置
- 确认 `.env` 文件中的API密钥正确
- 检查API密钥是否有余额
- 查看后端控制台日志

### 2. 无法连接到服务器

**错误信息：**
```
无法连接到服务器，请检查后端服务是否启动
```

**解决方案：**

1. **启动后端服务**
   ```bash
   cd server
   npm install  # 首次运行
   npm start
   ```

2. **检查端口占用**
   ```bash
   # Windows
   netstat -ano | findstr :3000
   
   # Mac/Linux
   lsof -ti:3000
   ```

3. **修改端口（如果3000被占用）**
   - 修改 `server/.env` 中的 `PORT=3000` 为其他端口
   - 修改 `utils/ai.js` 中的 `API_BASE_URL` 端口号

### 3. AI API密钥错误

**错误信息：**
```
AI服务未配置API密钥
```

**解决方案：**

1. **检查环境变量文件**
   ```bash
   cd server
   # 确保存在 .env 文件
   cat .env
   ```

2. **配置API密钥**
   ```env
   DEEPSEEK_API_KEY=sk-your-actual-api-key
   ```

3. **重启后端服务**
   ```bash
   npm start
   ```

### 4. 任务导入失败

**错误信息：**
```
导入任务失败: ...
```

**可能原因：**
- AI没有识别到任务需求
- JSON解析失败
- 任务格式不正确

**解决方案：**

1. **明确表达任务需求**
   - 使用"我想提高XX"、"我要学习XX"等明确句式
   - 避免模糊表述

2. **检查AI回复**
   - 查看AI回复中是否包含`<task>`标签
   - 检查JSON格式是否正确

3. **查看控制台日志**
   - 检查是否有解析错误
   - 查看任务数据结构

### 5. 任务进度不更新

**可能原因：**
- 没有进行中的任务
- 每日战报内容不够详细
- AI评估失败

**解决方案：**

1. **确保有进行中的任务**
   - 检查任务列表
   - 确认任务未完成

2. **提供详细的战报内容**
   - 描述具体完成的工作
   - 包含任务相关的信息

3. **检查后端日志**
   - 查看AI API调用是否成功
   - 检查进度更新数据

## 调试技巧

### 1. 查看控制台日志

**前端日志：**
- 打开微信开发者工具控制台
- 查看网络请求和错误信息

**后端日志：**
- 查看后端服务控制台输出
- 检查API调用日志

### 2. 测试后端服务

```bash
# 健康检查
curl http://localhost:3000/health

# 测试AI接口
curl -X POST http://localhost:3000/api/chat \
  -H "Content-Type: application/json" \
  -d '{
    "messages": [{"role": "user", "content": "你好"}]
  }'
```

### 3. 检查网络请求

在微信开发者工具中：
1. 打开"网络"面板
2. 查看请求状态码
3. 检查请求和响应数据

## 性能优化

### 1. 减少超时时间

如果AI响应很快，可以减少超时时间：
```javascript
// utils/ai.js
timeout: 30000  // 30秒
```

### 2. 优化系统提示词

如果系统提示词太长，可能导致响应变慢：
- 精简提示词内容
- 减少上下文信息

### 3. 分批处理任务

如果任务很多，可以分批处理：
- 限制每次导入的任务数量
- 分批更新任务进度

## 联系支持

如果以上方法都无法解决问题：

1. **收集错误信息**
   - 完整的错误堆栈
   - 控制台日志
   - 网络请求详情

2. **检查环境**
   - Node.js版本
   - 微信开发者工具版本
   - 操作系统版本

3. **查看文档**
   - `QUICK_START.md` - 快速开始
   - `LOCAL_DEPLOYMENT.md` - 部署文档
   - `AGENT_SYSTEM_GUIDE.md` - Agent系统指南

---

**提示**：大部分问题都是由于后端服务未启动或配置错误导致的，请先检查这些基础配置。

